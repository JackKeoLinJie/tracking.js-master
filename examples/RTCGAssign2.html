<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="style.css" />
    <script src="../build/dat.gui.min.js"></script>
    <script src="../build/tracking-min.js"></script>
    <title>RTCG Assignment 2</title>
</head>

<body>
    <h2>Convert an image with Opencv.js</h2>
    <p id="status">OpenCV.js is loading...</p>
    <table>
        <tr>
            <th>source</th>
            <th>output</th>
            <th>feature</th>
        </tr>
        <tr>
            <td>
                <img id="src-image" style="width: 400px;" />
            </td>
            <td>
                <canvas id="dest-canvas" width="400" height="400" style="width: 400px;"></canvas>
            </td>
            <td>
                <canvas id="features-canvas" width="400" height="400" style="width: 400px;"></canvas>
            </td>
        </tr>
        <tr>
            <td>
                <input type="file" id="input-file" />
            </td>
            <td>
                <input type="button" value="convert to grayscale" id="gray-scale-btn" />
                <a href="#" id="download-btn" download="converted.png">Save image</a>
            </td>
            <td>
                <input type="button" value="Detect Features" id="feature-detection-btn" />
                <button id="download-featured-btn">Download Featured Image</button>
            </td>
        </tr>
    </table>


    <script async src="../build/converter.js" type="text/javascript"></script>
    <script src="../build/opencv.js" onload="onOpenCvReady();" type="text/javascript"></script>
    <script>
        window.onload = function() {
            var canvas = document.getElementById('features-canvas');
            var context = canvas.getContext('2d');
            var image = document.getElementById('dest-canvas');
            var inputImage = document.getElementById('src-image');

            window.fastThreshold = 10;

            var doFindFeatures = function() {
                var width = inputImage.width;
                var height = inputImage.height;

                canvas.width = width;
                canvas.height = height;

                tracking.Fast.THRESHOLD = window.fastThreshold;
                context.drawImage(image, 0, 0, width, height);

                var imageData = context.getImageData(0, 0, width, height);
                var gray = tracking.Image.grayscale(imageData.data, width, height);
                var corners = tracking.Fast.findCorners(gray, width, height);

                for (var i = 0; i < corners.length; i += 2) {
                    context.fillStyle = '#f00';
                    context.fillRect(corners[i], corners[i + 1], 3, 3);
                }
            };

            document.getElementById('feature-detection-btn').addEventListener('click', function() {
                doFindFeatures();
            });

            document.getElementById('download-featured-btn').addEventListener('click', function() {
                var image = canvas.toDataURL("image/png").replace("image/png", "image/octet-stream");
                var link = document.createElement('a');
                link.setAttribute('href', image);
                link.setAttribute('download', 'featured_image.png');
                link.click();
            });

            var gui = new dat.GUI();
            gui.add(window, 'fastThreshold', 0, 100).onChange(doFindFeatures);
        }
    </script>

</body>

</html>